(function(){ActivityMap=function(b,a){this.data=b;this.id="example-activity-map";this.parent="body";this.hue=85;this.title="Activity map: ";this.timeColumn="t";this.valueColumn="v";this.fit=false;if(a){if(a.id!==undefined){this.id=a.id}if(a.parent!==undefined){this.parent=a.parent}if(a.colours!==undefined){this.colours=a.colours}if(a.title!==undefined){this.title=a.title}if(a.timeColumn!==undefined){this.timeColumn=a.timeColumn}if(a.valueColumn!==undefined){this.valueColumn=a.valueColumn}if(a.fit!==undefined){this.fit=a.fit}if(a.hue!==undefined){if(isNaN(a.hue)){throw"Invalid Hue specification: should be an integer"}else{if(a.hue<0||a.hue>360){throw"Invalid Hue specification: should be >= 0 and <= 360"}else{this.hue=a.hue}}}}this.luminosityScale=d3.scale.linear();this.init()};ActivityMap.prototype={init:function(){var b=this,a;b.process();if(typeof b.parent==="string"){a=d3.select(b.parent)}b.node=a.append("div").attr("id",b.id).attr("class","activity-map");b.parent=a;b.months={"0":{n:31,l:"January"},"1":{n:28,l:"February"},"2":{n:31,l:"March"},"3":{n:30,l:"April"},"4":{n:31,l:"May"},"5":{n:30,l:"June"},"6":{n:31,l:"July"},"7":{n:31,l:"August"},"8":{n:30,l:"September"},"9":{n:31,l:"October"},"10":{n:30,l:"November"},"11":{n:31,l:"December"}};b.weeks="SMTWTFS"},reorderColours:function(){var e=this,f=e.colours,d,b=0,a=f.length-1;while(b<a){d=f[b];f[b++]=f[a];f[a--]=d}},process:function(){var x=this,z=x.data,b,e={},g,k,q,n,s,j,h,l=[],p={},r=Number.MAX_VALUE,o=0,w=Number.MAX_VALUE,u=0,f=x.timeColumn,a=x.valueColumn;for(n=0,s=z.length;n<s;++n){b=z[n];if(b){j=b[f];if(!(j instanceof Date)){j=new Date(parseInt(j))}g=j.getFullYear();k=j.getMonth();q=j.getDate()-1;h=parseFloat(b[a]);if(e[g]===undefined){e[g]={}}if(e[g][k]===undefined){e[g][k]={}}if(e[g][k][q]===undefined){e[g][k][q]=h}if(r>g){r=g}if(o<g){o=g}if(w>h){w=h}if(u<h){u=h}if(p[g]===undefined){p[g]=g;l.push(g)}}}x.luminosityScale.domain([0,u]);x.luminosityScale.range([100,0]);x.processed={m:r,M:o,v:w,V:u,y:l,l:e}},renderMonth:function(f,s,g,q){var r=this,k,h,c,t,u,p=r.months[g],a=r.processed.l,b=r.colours,o;c=f.append("div").attr("class","amap-month");c.append("div").attr("class","amap-month-name").text(p.l);for(k=0;k<q;++k){c.append("div").attr("class","amap-empty-day")}for(h=0,q=p.n;h<q;++k,++h){t=c.append("div").attr("class","amap-week-day");if(k%7===0){t.classed("amap-week-start",true)}try{u=a[s][g][h];if(u){o=r.luminosityScale(u)+"%";t.classed("has-value",true).attr("title",s+"-"+(g+1)+"-"+(h+1)+": "+u).style("background-color",d3.hsl("hsl("+r.hue+","+100+"%,"+o+")"))}}catch(l){}}q=k%7;while(k++%7){c.append("div").attr("class","amap-empty-day")}c=c.append("div").attr("class","amap-week-names");for(k=0;k<7;++k){c.append("div").attr("class","amap-week-name").text(r.weeks[k])}return q},renderYear:function(f){var b=this,c,a,e;b.months[1].n=f%4?28:29;e=b.blocks.append("div").attr("class","amap-year-block").attr("year",f);e.append("div").attr("class","amap-year-name").text(f);e=e.append("div").attr("class","amap-months");c=new Date(f,0,1);c=c.getDay();for(a=0;a<12;++a){c=b.renderMonth(e,f,a,c)}},isVisible:function(d,b){var a=d.getBoundingClientRect(),c=b.getBoundingClientRect();return !(a.top>c.bottom||a.bottom<c.top)},onScroll:function(c){var d=Number.MAX_VALUE,a=0,b;c.blocks.selectAll(".amap-year-block").each(function(){if(c.isVisible(this,c.blocks.node())){b=parseInt(d3.select(this).attr("year"));if(d>b){d=b}if(a<b){a=b}}});if(d===a){c.year.text(c.title+a)}else{c.year.text(c.title+d+"-"+a)}},render:function(){var d=this,b,e,a=d.processed.y;d.year=d.node.append("div").attr("class","amap-title");d.blocks=d.node.append("div").attr("class","amap-year-blocks");d.blocks.on("scroll",function(){d.onScroll(d)});for(b=0,e=a.length;b<e;++b){d.renderYear(a[b])}d.onScroll(d);d.refit()},refit:function(){var a=this;if(!a.fit){a.blocks.style("height",(parseInt(a.node.style("height"))-parseInt(a.year.style("height")))+"px")}}}})();